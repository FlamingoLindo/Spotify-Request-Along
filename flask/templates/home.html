<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="keywords"
      content="Twitch, Spotify, Python, Flask, Oauth2, Requests, API, Tailwind"
    />
    <meta name="author" content="https://github.com/FlamingoLindo" />
    <meta
      name="description"
      content="Request Along: search Spotify tracks and open them quickly."
    />

    <link
      rel="stylesheet"
      href="{{url_for('static',filename='styles/home.css')}}"
    />
    <link
      rel="icon"
      type="image/x-icon"
      href="{{url_for('static',filename='buh.ico')}}"
    />

    <title>Request Along</title>
  </head>

  <body>
    <main class="page">
      <header class="title-wrapper">
        <h1 class="title">Request Along</h1>
      </header>

      <section class="search-wrapper">
        <form class="search-form" autocomplete="off">
          <span class="search-icon" aria-hidden="true">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="w-5 h-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M21 21l-4.35-4.35M17 11A6 6 0 1 1 5 11a6 6 0 0 1 12 0z"
              />
            </svg>
          </span>

          <input
            type="text"
            class="search-input"
            placeholder="Search a track..."
            aria-label="Search a track"
            onkeydown="return event.key != 'Enter';"
          />
        </form>

        <div id="results"></div>
      </section>
    </main>

    <script>
      const input = document.querySelector(".search-input");
      const resultsDiv = document.getElementById("results");
      let debounceTimer;
      let controller;

      function playTrack(uri) {
        fetch(`/spotify/play/${uri}`, { method: "PUT" })
          .then((res) => {
            if (res.ok || res.redirected) window.location.href = res.url;
          })
          .catch((e) => console.error("Playback error:", e));
      }

      if (!resultsDiv) {
        console.error('Missing <div id="results"></div> in the HTML.');
      }

      input.addEventListener("input", () => {
        if (!resultsDiv) return;

        clearTimeout(debounceTimer);
        if (controller) controller.abort();

        const query = input.value.trim();

        if (!query) {
          resultsDiv.innerHTML = "";
          return;
        }

        debounceTimer = setTimeout(async () => {
          resultsDiv.innerHTML = `<p class="results-status">Searching...</p>`;
          controller = new AbortController();

          try {
            const res = await fetch(
              `/spotify/search?q=${encodeURIComponent(query)}`,
              { signal: controller.signal },
            );

            if (!res.ok) throw new Error("Bad response");

            const tracks = await res.json();

            if (!tracks.length) {
              resultsDiv.innerHTML = `<p class="results-status">No results found.</p>`;
              return;
            }

            resultsDiv.innerHTML = tracks
              .map(
                (t) => `
                  <a class="track-card" href="${t.url}" target="_blank" rel="noopener noreferrer">
                    ${
                      t.image
                        ? `<img src="${t.image}" alt="${t.name} album art" loading="lazy">`
                        : `<div class="track-fallback" aria-hidden="true">♪</div>`
                    }
                    <div class="track-info">
                      <span class="track-name">${t.name}</span>
                      <span class="track-sub">${t.artist} · ${t.album}</span>
                    </div>
                    <span class="track-meta" aria-hidden="true" onclick="event.preventDefault(); event.stopPropagation(); playTrack('${encodeURIComponent(t.uri)}')">Play</span>
                  </a>
                `,
              )
              .join("");
          } catch (e) {
            if (e.name !== "AbortError") {
              resultsDiv.innerHTML = `<p class="results-status">Something went wrong.</p>`;
              console.error(e);
            }
          }
        }, 400);
      });
    </script>
  </body>
</html>
